# Authentication

## Strategy

```shell
# With shell, you can just pass the correct header with each request
curl "https://api.handshq.com/v1/authentication" \
  -H "Accept: application/json"  \
  -H "Authorization: bearer [api_token]"
```

> In all subsequent examples make sure to replace `[api_token]` with your API key.

HandsHQ uses API keys to allow access to the API. You can find your API key in the API tab of your settings page
[here.](https://app.handshq.com/settings/api_configuration)


HandsHQ expects for the API key to be included in all API requests to the server in a header that looks like the following:

`Authorization: bearer [api_token]`

<aside class="notice">
You must replace <code>[api_token]</code> with your personal API key.
</aside>


## Testing your authentication details

If you need to test that you have a valid API key use the following endpoint:

### Request

`GET https://api.handshq.com/v1/authentication`

### Response

Successful authentication with return a `200` response, otherwise a `401` will be returned when supplied with an invalid API key.

> 200

```json
{
    "data": {
        "id": "dc729c6795ab40608f8d1a7e8d768e31",
        "type": "actor",
        "attributes": {
            "company_name": "Example Company Ltd"
        }
    }
}
```

## Verifying requests made by HandsHQ

### Verification strategy

While requests made to the HandsHQ API require the authentication measures set out out [here](#strategy), we also provide measures to verify that any requests made from HandsHQ can be authenticated. Such requests are made as a result of subscribing for webhook notifications (e.g. `version_pdf_created`) where we will send a payload containing information about the event. e.g. attributes about a PDF that was just generated for one of your projects.

<aside class='notice'>
  Please note that while we provide such measures, it is still up to those who wish to receive webhook notifications to check the authenticity of the incoming requests with the described strategy.
</aside>

Our strategy involves the generation of a HMAC hex digest per request sent by HandsHQ.

This signature value is constructed using a shared private key and the contents of the request, meaning that it can be generated only by HandsHQ and those that hold the private key. If the signature value that is generated by HandsHQ matches the signature value generated by the webhook consumer then the request can be deemed verified.

### Signature details

The signature can be found in a custom header called `X-Handshq-Webhook-Signature`.

This value is generated for every webhook event request.

HandsHQ uses a HMAC hex digest for the signature value, which has been generated using:

- Hashing Algorithm: `SHA-256`
- Key: Your HandsHQ `api_token`
- Data: The body of the request.

If you wish to be able to generate a signature value to compare against then you will need to be able use the same hashing algorithm and encoding with the same private key and data.

### Example authentication workflow

> Example Ruby-On-Rails controller contents

```ruby
  
  before_action :ensure_valid_signature

  def create
    # consume webhook
  end

  private

  def ensure_valid_signature
    # handle invalid signatures, e.g. return a 404 status
    raise 'oh no - an invalid signature!' unless valid_signature?
  end

  def valid_signature?
    # retrieve hex-encoded HMAC digest
    provided_signature = request.headers['X-Handshq-Webhook-Signature']
    # generate your own
    generated_signature = OpenSSL::HMAC.hexdigest('sha256', ENV['MY_HANDSHQ_ACCESS_TOKEN'], request.body.read)
    # compare values
    Rack::Utils.secure_compare(generated_signature, provided_signature)
  end
```
> Note that different languages and frameworks will have their own ways of achieving the workflow as described, and will have their own considerations of best practice, for example in this case the use of `#secure_compare` 

Once you have an endpoint which is able to receive notifications and have registered an `event subscription` with the URL pointing to this endpoint, you can do the following to e

- Obtain the value of the signature from the `X-Handshq-Webhook-Signature` header
- Generate a HMAC digest with the details as described [here](#signature-details)
- Generate a hex-encoded value of the digest
- Compare the value of the hex-encoded digest with the value in `X-Handshq-Webhook-Signature`
- Reject the request if the values do not match.

### Additional considerations

- The signature would only be deemed secure so long as your `api_key` is kept a secret.
- All URLs for webhook destinations must be using https to ensure that the contents of the request are secure.
- If you wish to automatically remove an event subscription after it contacts your endpoint, by returning a `410 gone` http status we will automatically remove your event subscription so that you do not need to manually remove it later [via the api](#removing-an-event-subscription).
- Because the signature is generated using both the `api_key` and the body of the request, if either are incorrect then the comparison between digests will fail ensuring both authenticity of sender and request forgery protection.
